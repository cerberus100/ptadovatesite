version: "3.8"

services:
  nginx:
    image: nginx:1.25-alpine
    container_name: hh_nginx
    ports:
      - "${DOCKER_WP_PORT:-80}:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
      - wordpress_data:/var/www/html
      - ./wp-content:/var/www/html/wp-content
      - ../assets:/var/www/html/wp-content/themes/helpinghands/assets
    depends_on:
      - php
    restart: unless-stopped
    networks:
      - hh_network
    environment:
      - DEPLOYMENT_TYPE=${DEPLOYMENT_TYPE:-docker}
      - APP_ENV=${APP_ENV:-local}

  php:
    image: php:8.3-fpm-alpine
    container_name: hh_php
    volumes:
      - wordpress_data:/var/www/html
      - ./wp-content:/var/www/html/wp-content
      - ./php/php.ini:/usr/local/etc/php/php.ini
      - ../assets:/var/www/html/wp-content/themes/helpinghands/assets
    depends_on:
      - mariadb
      - redis
    restart: unless-stopped
    environment:
      - DB_HOST=${DB_HOST:-mariadb}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - WP_DEBUG=${WP_DEBUG:-true}
      - XDEBUG_MODE=${XDEBUG_MODE:-debug}
      - DEPLOYMENT_TYPE=${DEPLOYMENT_TYPE:-docker}
      - APP_ENV=${APP_ENV:-local}
      - WP_SITE_URL=${WP_SITE_URL:-http://localhost}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - AWS_REGION=${AWS_REGION}
      - AWS_S3_BUCKET=${AWS_S3_BUCKET}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AUTH_KEY=${AUTH_KEY}
      - SECURE_AUTH_KEY=${SECURE_AUTH_KEY}
      - LOGGED_IN_KEY=${LOGGED_IN_KEY}
      - NONCE_KEY=${NONCE_KEY}
      - AUTH_SALT=${AUTH_SALT}
      - SECURE_AUTH_SALT=${SECURE_AUTH_SALT}
      - LOGGED_IN_SALT=${LOGGED_IN_SALT}
      - NONCE_SALT=${NONCE_SALT}
    networks:
      - hh_network
    command: >
      sh -c "
        apk add --no-cache \
          freetype-dev \
          libjpeg-turbo-dev \
          libpng-dev \
          libzip-dev \
          icu-dev \
          oniguruma-dev \
          autoconf \
          g++ \
          make \
        && docker-php-ext-configure gd --with-freetype --with-jpeg \
        && docker-php-ext-install -j\$$(nproc) \
          gd \
          intl \
          mysqli \
          pdo_mysql \
          zip \
          opcache \
          mbstring \
        && pecl install redis \
        && docker-php-ext-enable redis \
        && curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar \
        && chmod +x wp-cli.phar \
        && mv wp-cli.phar /usr/local/bin/wp \
        && php-fpm
      "

  mariadb:
    image: mariadb:10.11
    container_name: hh_mariadb
    ports:
      - "${DOCKER_DB_PORT:-3306}:3306"
    volumes:
      - mariadb_data:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD:-rootpassword123!}
      - MYSQL_DATABASE=${DB_NAME}
      - MYSQL_USER=${DB_USER}
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - MYSQL_CHARSET=utf8mb4
      - MYSQL_COLLATION=utf8mb4_unicode_ci
    restart: unless-stopped
    networks:
      - hh_network
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --max_connections=200
      --innodb_buffer_pool_size=256M

  redis:
    image: redis:7-alpine
    container_name: hh_redis
    ports:
      - "${DOCKER_REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - hh_network
    command: >
      redis-server 
      --appendonly yes 
      --requirepass ${REDIS_PASSWORD:-redis_secure_password_2024!}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru

  adminer:
    image: adminer:4.8.1
    container_name: hh_adminer
    ports:
      - "${DOCKER_ADMINER_PORT:-8080}:8080"
    depends_on:
      - mariadb
    restart: unless-stopped
    networks:
      - hh_network
    environment:
      - ADMINER_DEFAULT_SERVER=mariadb

  wpcli:
    image: wordpress:cli-php8.3
    container_name: hh_wpcli
    volumes:
      - wordpress_data:/var/www/html
      - ./wp-content:/var/www/html/wp-content
    depends_on:
      - mariadb
      - php
    environment:
      - WORDPRESS_DB_HOST=mariadb
      - WORDPRESS_DB_NAME=${DB_NAME}
      - WORDPRESS_DB_USER=${DB_USER}
      - WORDPRESS_DB_PASSWORD=${DB_PASSWORD}
    networks:
      - hh_network
    entrypoint: wp
    command: "--info"

volumes:
  wordpress_data:
    name: hh_wordpress_data
  mariadb_data:
    name: hh_mariadb_data
  redis_data:
    name: hh_redis_data

networks:
  hh_network:
    driver: bridge 